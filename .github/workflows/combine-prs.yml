name: "Combine PRs"

# Controls when the action will run - in this case triggered manually
on:
  workflow_dispatch:
    inputs:
      branchPrefix:
        description: "Branch prefix to find combinable PRs based on"
        required: true
        default: "dependabot"
  pull_request:
    types:
      - opened
    branches: -'dependabot/**'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # outputs:
  #   fetch-branch-names: ${{steps.fetch-branch-names.outputs.values}}

  # pull_request_target:
  #   - type:
  #       - opened
  #   - branches:
  #       - "dependabot/**"

  # Steps represent a sequence of tasks that will be executed as part of the job
  Component_types:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        search_labels: ["ui", "api"]
    outputs:
      source-branches: ${{ steps.fetch-source-branches.outputs.result }}
      joined-pr-titles: ${{ steps.join-pr-title-strings.outputs.result }}
      parent-branch-name: ${{ steps.create-combined-branch-name.outputs.result }}
      base-branch: ${{ steps.fetch-source-branches.outputs.base-branch }}
      pr-label: ${{ steps.create-labels-for-new-pr.outputs.result }}
    steps:
      - name: Fetch branch names
        id: fetch-prs
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            let pulls
            if("${{matrix.search_labels}}" == "ui")
            pulls = await github.rest.search.issuesAndPullRequests({
              q:"dependabot+repo:AlexSCorey/dependabot-test+is:pr+is:open+label:component:ui+label:dependencies"
            });

            if("${{matrix.search_labels}}" === "api")
            pulls = await github.rest.search.issuesAndPullRequests({
              q:"dependabot+repo:AlexSCorey/dependabot-test+is:pr+label:component:api+label:dependencies"
            });

            return pulls.data.items
      - name: Fetch Source Branches
        id: fetch-source-branches
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            branches = []
            let base_branch
            for(const pull of ${{ steps.fetch-prs.outputs.result}}){
              const pr = await github.request("GET /repos/AlexSCorey/dependabot-test/pulls/{id}",{id:pull.number})
              branches.push(pr.data['head']['ref'])
            base_branch = pr.data['base']['ref']
            }
            core.setOutput('base-branch', base_branch);
            joinedBranches = branches.join(" ")
            return joinedBranches
      - name: Join Pr Title Strings
        id: join-pr-title-strings
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            prs = []
            for(const pull of ${{ steps.fetch-prs.outputs.result}}){
              const response = await github.request("GET /repos/AlexSCorey/dependabot-test/pulls/{id}",{id:pull.number})
              console.log(response, 'response for pr sttring')
              prs.push('#' + response['number'] + ' ' + response['title']);
            }
            return prs
      - name: Create Combined Branch Name
        id: create-combined-branch-name
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            branchName = 'UIDependencyBumpCreatedbyDependbot'
            if ("${{ matrix.search_labels }}" == "api"){
                combinedBranchName = 'ApiDependencyBumpCreatedByDependabot'
              }
            return branchName
      - name: Create Labels for new PR
        id: create-labels-for-new-pr
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            label = 'label:component:ui+label:dependencies'
            if ("${{ matrix.search_labels }}" == "api"){
                label = 'label:component:api+label:dependencies'
              }
            return label

      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it

  Create_Branch_and_Make_PR:
    runs-on: ubuntu-latest
    needs: Component_types
    steps:
      - name: Check out repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      # Creates a branch with other PR branches merged together
      - name: Created source branch
        id: created-source-branch
        env:
          BASE_BRANCH: ${{ needs.Component_types.outputs.base-branch }}
          SOURCE_BRANCHES: "${{ needs.Component_types.outputs.source-branches }}"
          COMBINE_BRANCH_NAME: "${{ needs.Component_types.outputs.parent-branch-name}}"
        run: |


          # echo "$BRANCHES_TO_COMBINE"
          # echo "check branches"
          sourcebranches="${BRANCHES_TO_COMBINE%\"}"
          sourcebranches="${sourcebranches#\"}"

          basebranch="${BASE_BRANCH%\"}"
          basebranch="${basebranch#\"}"

          git config pull.rebase false
          git config user.name github-actions
          git config user.email github-actions@github.com

          git branch $COMBINE_BRANCH_NAME $basebranch
          git checkout $COMBINE_BRANCH_NAME
          git pull origin $sourcebranches --no-edit
          git push origin $COMBINE_BRANCH_NAME

      - name: Create Combined Pull Request
        uses: actions/github-script@v3
        env:
          PR_STRINGS: ${{ needs.Component_types.outputs.joined-pr-titles }}
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const prString = PR_STRINGS
            const body = 'This PR was created by the Combine PRs action by combining the following PRs:\n' + {{PR_STRINGS}};
            await github.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Combined PR',
              head: ${{ env.COMBINE_BRANCH_NAME }},
              base: '${{ needs.Component_types.outputs.base-branch }}',
              body: body
              labels:[${{ needs.Component_types.outputs.pr-label }}]
            });
      # - name: Close PRs that were combined
      #   run: |
      #     for (const pr of '${{ steps.fetch-branch-names.outputs.prs}}') {
      #       console.log(pr)
